name: Auto Deploy

on:
    push:
        branches: [main]

jobs:
    deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Deploy
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.SERVER_IP }}
                  username: ${{ secrets.SERVER_USER }}
                  key: ${{ secrets.DEPLOY_SSH_KEY }}
                  script: |
                      sudo rm -f /var/www/html/index.html
                      mkdir -p ~/repo-temp
                      cd ~/repo-temp
                      git clone https://github.com/Oghenekparobo/hng13-stage0-devops.git . || git pull
                      sudo cp index.html /var/www/html/index.html
                      sudo chown www-data:www-data /var/www/html/index.html
                      sudo chmod 644 /var/www/html/index.html
                      sudo nginx -t && sudo systemctl reload nginx
                      cd ~
                      rm -rf repo-temp
